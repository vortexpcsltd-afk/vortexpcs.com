rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isWhitelistedAdminEmail() {
      // Add additional trusted emails here if needed
      return isAuthenticated() && (
        request.auth.token.email == 'admin@vortexpcs.com' ||
        request.auth.token.email == 'info@vortexpcs.com'
      );
    }

    function isAdmin() {
      return isAuthenticated() && (
        isWhitelistedAdminEmail() ||
        request.auth.token.email == 'admin@vortexpcs.com' ||
        request.auth.token.email == 'info@vortexpcs.com'
      );
    }
    
    // Users collection
    match /users/{userId} {
      // Users can always read their own profile (even if it doesn't exist)
      // This allows the app to check if profile exists and create it if needed
      allow read: if isAuthenticated() && (request.auth.uid == userId || isWhitelistedAdminEmail());
      
      // Users can create their own profile on signup or first login
      // Ensure they can only set role to 'user' unless they're a whitelisted admin
      allow create: if isAuthenticated() && request.auth.uid == userId && 
                       (request.resource.data.role == 'user' || 
                        !('role' in request.resource.data) ||
                        isWhitelistedAdminEmail());
      
      // Users can update their own profile, but cannot change their role unless admin
      // Allow updates even if document doesn't exist yet (for race conditions)
      allow update: if isAuthenticated() && 
                       ((request.auth.uid == userId && 
                         (!('role' in request.resource.data) ||
                          !exists(/databases/$(database)/documents/users/$(userId)) ||
                          request.resource.data.role == resource.data.role)) || 
                        isWhitelistedAdminEmail());
      
      // Only admins can delete users
      allow delete: if isAdmin();
    }
    
    // Orders collection
    match /orders/{orderId} {
      // Users can read orders where they are the userId OR where their email matches
      // Admins can read all orders
      // For list queries, only check if user is admin (can't check resource.data in list query)
      allow read: if isAuthenticated() && (
                     isAdmin() ||
                     (resource != null && (
                       resource.data.userId == request.auth.uid ||
                       resource.data.customerEmail == request.auth.token.email
                     ))
                   );
      
      // Authenticated users can create orders
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own orders (for claiming), admins can update any
      allow update: if isAuthenticated() && (
                       isAdmin() ||
                       resource.data.userId == request.auth.uid ||
                       resource.data.customerEmail == request.auth.token.email
                     );
      
      // Only admins can delete orders
      allow delete: if isAdmin();
    }
    
    // Saved configurations
    match /configurations/{configId} {
      // Users can read their own configurations
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Users can create their own configurations
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own configurations
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Users can delete their own configurations
      allow delete: if isAuthenticated() && request.auth.uid == resource.data.userId;
    }
    
    // Support tickets
    match /support_tickets/{ticketId} {
      // Anyone can create a support ticket
      allow create: if true;
      
      // Users can read their own tickets, admins can read all
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || isAdmin());
      
      // Only admins can update tickets
      allow update: if isAdmin();
      
      // Only admins can delete tickets
      allow delete: if isAdmin();
    }
    
    // Refund requests
    match /refund_requests/{requestId} {
      // Users can create refund requests for their own orders
      allow create: if isAuthenticated();
      
      // Users can read their own refund requests, admins can read all
      allow read: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || isAdmin());
      
      // Only admins can update refund requests
      allow update: if isAdmin();
      
      // Only admins can delete refund requests
      allow delete: if isAdmin();
    }
    
    // Deleted orders audit log
    match /deleted_orders/{docId} {
      // Only admins can create (when deleting orders)
      allow create: if isAdmin();
      
      // Only admins can read
      allow read: if isAdmin();
      
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // Analytics collection (write-only for tracking)
    match /analytics/{docId} {
      // Anyone can write analytics data
      allow create: if true;
      
      // Only admins can read analytics
      allow read: if isAdmin();
      
      // No updates or deletes
      allow update, delete: if false;
    }

    // Advanced analytics: sessions (public write; admin read)
    // Allow anonymous clients to create and update ONLY specific fields of their own session doc.
    match /analytics_sessions/{sessionId} {
      // Anyone can create a session document
      allow create: if true;

      // Allow updates to activity fields only
      // Do NOT check referrer, userAgent, device, location equality since objects fail equality checks
      allow update: if
        // Ensure core session ID doesn't change
        request.resource.data.sessionId == resource.data.sessionId &&
        // Only allow these fields in updates
        request.resource.data.keys().hasOnly([
          "sessionId",
          "userId", 
          "startTime",
          "lastActivity",
          "pageViews",
          "pages",
          "referrer",
          "userAgent",
          "location",
          "device",
          "isActive"
        ]) &&
        // Type validation for changeable fields
        request.resource.data.lastActivity is timestamp &&
        request.resource.data.pageViews is number &&
        request.resource.data.pages is list &&
        request.resource.data.isActive is bool;

      // Only admins can read sessions
      allow read: if isAdmin();

      // No deletes from clients
      allow delete: if false;
    }

    // Advanced analytics: pageviews (public write; admin read)
    match /analytics_pageviews/{docId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // Advanced analytics: custom events (public write; admin read)
    match /analytics_events/{docId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    // Advanced analytics: security events (public write; admin read)
    match /security_events/{docId} {
      allow create: if true;
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    
    // Product reviews (if implemented)
    match /reviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated();
      
      // Users can update their own reviews
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Users can delete their own reviews, admins can delete any
      allow delete: if (isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
