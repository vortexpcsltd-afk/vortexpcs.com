name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
          cache-dependency-path: 'Website Files/package-lock.json'

      - name: Install dependencies
        working-directory: ./Website Files
        run: npm ci

      - name: Build
        working-directory: ./Website Files
        run: npm run build --if-present

      - name: Inject version & cache bust
        working-directory: ./Website Files
        run: |
          set -e
          VERSION="$(date -u +%Y-%m-%d-%H%M%S)-${GITHUB_SHA:0:8}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "{\"version\":\"$VERSION\",\"timestamp\":\"$TIMESTAMP\",\"build\":\"github-actions\"}" > dist/version.json
          # Inject version meta into index.html for quick visibility/debugging
          if grep -q '<meta name="cache-version"' dist/index.html; then
            sed -i "s|<meta name=\"cache-version\" content=\"\" />|<meta name=\"cache-version\" content=\"$VERSION\" />|" dist/index.html || true
          fi
          # Append ?v=VERSION to asset references in index.html to defeat CDN/browser caches of old chunks
          sed -i -E "s|(src=\"/assets/[^\"\?]*)(\"[^>]*>)|\1?v=$VERSION\2|g" dist/index.html || true
          sed -i -E "s|(href=\"/assets/[^\"\?]*)(\"[^>]*>)|\1?v=$VERSION\2|g" dist/index.html || true
          sed -i -E "s|(src=\"assets/[^\"\?]*)(\"[^>]*>)|\1?v=$VERSION\2|g" dist/index.html || true
          sed -i -E "s|(href=\"assets/[^\"\?]*)(\"[^>]*>)|\1?v=$VERSION\2|g" dist/index.html || true
          cp dist/index.html dist/404.html || echo "404 fallback copy skipped"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: Website Files/dist
          keep_files: false
          force_orphan: true

      - name: Show deployed version file
        run: cat "Website Files/dist/version.json" || echo "No version.json"